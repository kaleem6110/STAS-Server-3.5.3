
<html>
  <head>
    <script src="http://www.google.com/jsapi?key=ABQIAAAAfSCem-4sdXrrt_sARmNMHxQdjlnwEP3qVJXZOYhzPYW8NvMAwxQNWgHNgiOo9WJhKV5YlosvnL_rYw"></script>
    <script type="text/javascript" src="magma_ajax.js"></script>
    <script>
    var kmlUrlList = new Array();

	  kmlUrlList[0] = "http://localhost:8090/magma/MAGMARequestHandler?ecoexpmodel=ServicePersonnel2.ecoexpml&rendertype=kml";

	  google.load("earth", "1");
	  google.load("maps", "2");
	  var ge = null;
	  var networkLinksArray = new Array();
	  var viewFormat = "bboxWest=[bboxWest]&bboxSouth=[bboxSouth]&bboxEast=[bboxEast]&bboxNorth=[bboxNorth]&lookatLon=[lookatLon]&lookatLat=[lookatLat]&lookatRange=[lookatRange]&lookatTilt=[lookatTilt]&lookatHeading=[lookatHeading]&horizFov=[horizFov]&vertFov=[vertFov]&horizPixels=[horizPixels]&vertPixels=[vertPixels]&terrainEnabled=[terrainEnabled]";

	  function init() {
	    google.earth.createInstance("map3d", initCallback, failureCallback);
	    geocoder = new GClientGeocoder();
	  }

	  function initCallback(object) {
	    ge = object;
	    ge.getWindow().setVisibility(true);
	    ge.getNavigationControl().setVisibility(ge.VISIBILITY_SHOW);
	    var layerRoot = ge.getLayerRoot();
	    var terrainLayer = layerRoot.getLayerById(ge.LAYER_TERRAIN);
	    if (terrainLayer.getVisibility()) {
	      layerRoot.enableLayerById(ge.LAYER_TERRAIN, false);
	    }
	    for(i=0;i<kmlUrlList.length;i++){
	    	setTimeout("initAjax('"+kmlUrlList[i]+"','test"+i+"')",4000*(i+1));
	    }
	  }

  	  function failureCallback(object) {
	  }

	  function submitLocation( address ) {
	    geocoder.getLatLng( address,
	      function(point){
	        if (point && ge != null) {
	          var la = ge.createLookAt('');
	          la.set(point.y, point.x, 100, ge.ALTITUDE_RELATIVE_TO_GROUND,0, 0, 400);
	          ge.getView().setAbstractView(la);
	        }
	      }
	    )
	  }

	  function initAjax(startKmlUrl, name){
		var ajaxRequest = google.maps.XmlHttp.create();
		ajaxRequest.onreadystatechange = function(){
		  if(ajaxRequest.readyState == 4){
			var xmldoc = google.maps.Xml.parse(ajaxRequest.responseText);
			kmlUrl = extractLink(xmldoc);
			if(!kmlUrl) {
			  alert('The KML could not be parsed, Please check the link.');
			  return;
			}
			linkParams = kmlUrl.split(",");
			refreshMode = 0;
			if(linkParams[2]=="onInterval"){
			  refreshMode = 1;
			}else if(linkParams[2]=="onRequest"){
			  refreshMode = ge.VIEW_REFRESH_ON_REQUEST;
			}else if(linkParams[2]=="onStop"){
			  refreshMode = ge.VIEW_REFRESH_ON_STOP;
			}else if(linkParams[2]=="onRegion"){
			  refreshMode = ge.VIEW_REFRESH_ON_REGION;
			} else {
			  refreshMode = ge.VIEW_REFRESH_NEVER;
			}
			loadNetworkLink(name, linkParams[0],refreshMode,linkParams[1]);
		  }
	    }
		ajaxRequest.open("GET", startKmlUrl, true);
		ajaxRequest.send(null);
      }

	  function loadNetworkLink(name, nLink,refreshMode,refreshInterval) {
		var networkLink = ge.createNetworkLink("");
		networkLink.setDescription("NetworkLink open to fetched content");
		networkLink.setName("Open NetworkLink");
		var link = ge.createLink("");

		if(refreshMode == ge.VIEW_REFRESH_ON_STOP){
		  link.setViewRefreshMode(refreshMode);
		  link.setViewRefreshTime(refreshInterval);
		  link.setViewFormat(viewFormat);
		}else{
		  link.setRefreshMode(refreshMode);
		  if(refreshInterval!=null){
			link.setRefreshInterval(refreshInterval);
		  }
		}
		sessionidPos = nLink.indexOf("jsessionid=");
		var sessionId = "0";
		if(sessionidPos!=-1){
		  sessionId = nLink.substring(sessionidPos+11,nLink.indexOf("&",sessionidPos));
		}
		link.setHref(nLink);
		networkLink.setLink(link);
		networkLinksArray[name] = networkLink;

		ge.getFeatures().appendChild(networkLink);
	  }
	  function openKml(url, name){
		if(!networkLinksArray[name]) {
			var networkLink = ge.createNetworkLink("");
			networkLink.setDescription("NetworkLink open to fetched content");
			networkLink.setName("Open NetworkLink");
			networkLink.setFlyToView(true);
			var link = ge.createLink("");
			link.setHref(url);
			networkLink.setLink(link);
			networkLinksArray[name] = networkLink;
			ge.getFeatures().appendChild(networkLink);
		} else {
			networkLinksArray[name].setFlyToView(true);
		}
	  }
    </script>
  </head>
  <body onload='init()'>
	<div id='map3d_container'style='border: 1px solid silver; height: 499px; width: 800px;' align="top">
		<div id='map3d' style='height: 100%;'></div>
	</div>
	<iframe name="popupFrame" src="" width="800" height="500" scrolling="no" allowautotransparency=true></iframe>
  </body>
</html>